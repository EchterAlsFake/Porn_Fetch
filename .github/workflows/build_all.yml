name: Cross-Platform Build Pipeline

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

permissions:
  contents: read

env:
  PYTHONUNBUFFERED: "1"

jobs:
  # ==========================================
  # 1. GUI BUILDS (PySide6)
  # ==========================================
  build-gui:
    name: GUI (${{ matrix.platform }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            arch: x64
            os: ubuntu-24.04
          - platform: linux
            arch: arm64
            os: ubuntu-24.04-arm
          - platform: windows
            arch: x64
            os: windows-latest
          - platform: windows
            arch: arm64
            os: windows-11-arm
          - platform: macos
            arch: x64
            os: macos-15-intel # Intel
          - platform: macos
            arch: arm64
            os: macos-latest # Apple Silicon

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          architecture: ${{ (matrix.platform == 'windows' && matrix.arch == 'x86') && 'x86' || (matrix.platform == 'macos' && matrix.arch == 'x64') && 'x64' || (matrix.arch) }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      # --- Platform Specific Setup ---
      - name: Linux Dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libegl1 libgles2 libxkbcommon-x11-0 libdbus-1-3 libxcb-cursor0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-shape0 libxcb-shm0 libxcb-util1 libxcb-xfixes0 libxcb-xinerama0 libxcb-xkb1 libgl1-mesa-dev xvfb

      - name: Windows ARM64 OpenSSL (vcpkg)
        if: matrix.platform == 'windows' && matrix.arch == 'arm64'
        shell: pwsh
        run: |
          $vcpkgRoot = Join-Path $env:RUNNER_TEMP "vcpkg"
          git clone --depth 1 https://github.com/microsoft/vcpkg $vcpkgRoot
          & "$vcpkgRoot\bootstrap-vcpkg.bat" -disableMetrics
          & "$vcpkgRoot\vcpkg.exe" install openssl --triplet arm64-windows
          echo "OPENSSL_DIR=$(Join-Path $vcpkgRoot 'installed\arm64-windows')" >> $env:GITHUB_ENV

      # --- Build Process ---
      - name: Sync Dependencies
        run: uv sync --extra dev --extra av

      - name: Fix Cryptography DLLs (Windows ARM64)
        if: matrix.platform == 'windows' && matrix.arch == 'arm64'
        shell: pwsh
        run: |
          # 1. Dynamically find where uv installed the cryptography package
          $cryptoPath = uv run python -c "import cryptography, os; print(os.path.dirname(cryptography.__file__))"
          
          # 2. Point to the bindings folder where _rust.pyd lives
          $dllTarget = Join-Path $cryptoPath "hazmat\bindings"
          
          # 3. Get the DLLs from our vcpkg OpenSSL installation
          $dllSource = Join-Path $env:OPENSSL_DIR "bin\*.dll"
          
          Write-Host "Injecting OpenSSL DLLs into $dllTarget so PyInstaller bundles them..."
          Copy-Item -Path $dllSource -Destination $dllTarget -Force

      - name: Frontend Update
        shell: bash
        run: |
          cd src/frontend && (bash update.sh || pwsh update.ps1 || true)
          cd ../scripts && uv run patch.py

      - name: Build with pyside6-deploy
        shell: bash
        run: |
          SPEC_FILE="src/build/pysidedeploy_${{ matrix.platform }}.spec"
          uv run -- pyside6-deploy -c $SPEC_FILE -f -v
          
          # Universal Rename Logic
          EXT="${{ matrix.platform == 'windows' && '.exe' || matrix.platform == 'macos' && '.app' || '.bin' }}"
          OUTPUT_NAME="PornFetch_${{ matrix.platform }}_GUI_${{ matrix.arch }}$EXT"
          
          if [ "${{ matrix.platform }}" == "macos" ]; then
             echo "DMG_OUTPUT=PornFetch_macOS_GUI_${{ matrix.arch }}.dmg" >> $GITHUB_ENV
          else
             mv "Porn Fetch$EXT" "$OUTPUT_NAME"
             echo "BIN_OUTPUT=$OUTPUT_NAME" >> $GITHUB_ENV
          fi

      # --- Packaging & QA ---
      - name: macOS DMG Packaging
        if: matrix.platform == 'macos'
        run: |
          mkdir dist_dmg
          cp -pR "Porn Fetch.app" dist_dmg/
          ln -s /Applications dist_dmg/Applications
          hdiutil create -volname "PornFetch" -srcfolder dist_dmg -ov -format UDZO "$DMG_OUTPUT"

      - name: Smoke Test
        if: matrix.platform != 'macos' # UI tests on Mac CI are notoriously flaky
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" == "linux" ]; then
            xvfb-run ./"$BIN_OUTPUT" -t
          else
            ./"$BIN_OUTPUT" -t
          fi

      - name: Checksum & Summary
        shell: bash
        run: |
          FILE="${{ env.BIN_OUTPUT || env.DMG_OUTPUT }}"
          sha256sum "$FILE" > "$FILE.sha256"
          echo "### SHA256 Checksum ($FILE)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`$(cat $FILE.sha256)\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PornFetch_${{ matrix.platform }}_GUI_${{ matrix.arch }}
          path: ${{ env.BIN_OUTPUT || env.DMG_OUTPUT }}

  # ==========================================
  # 2. CLI BUILDS (Standard x64/x86)
  # ==========================================
  build-cli:
    name: CLI (${{ matrix.platform }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - platform: linux
            arch: x64
            os: ubuntu-latest
          - platform: windows
            arch: x64
            os: windows-latest
          - platform: windows
            arch: x86
            os: windows-latest
          - platform: macos
            arch: x64
            os: macos-15-intel  # The dedicated Intel runner we used earlier
          - platform: macos
            arch: arm64
            os: macos-latest    # The native Apple Silicon runner

    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          architecture: ${{ matrix.arch }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Build
        shell: bash
        run: |
          uv sync --extra cli
          uv pip install pyinstaller
          uv run pyinstaller -F Porn_Fetch_CLI.py
          
          EXT="${{ matrix.platform == 'windows' && '.exe' || '' }}"
          OUT="PornFetch_${{ matrix.platform }}_CLI_${{ matrix.arch }}$EXT"
          mv dist/Porn_Fetch_CLI$EXT "$OUT"
          echo "CLI_OUTPUT=$OUT" >> $GITHUB_ENV
          sha256sum "$OUT" > "$OUT.sha256"

      - name: Test CLI
        shell: bash
        run: |
          ./${{ env.CLI_OUTPUT }} --test-mode

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CLI_${{ matrix.platform }}_${{ matrix.arch }}
          path: PornFetch_*

  # ==========================================
  # 3. CLI BUILD (Linux 32-bit - The Special Case)
  # ==========================================
  build-cli-linux-x32:
    name: CLI (linux-x32)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build 32-bit Python & Binary
        env:
          PY_VER: "3.13.5"
          PREFIX: "/opt/python-32"
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y build-essential gcc-multilib libffi-dev:i386 zlib1g-dev:i386 libssl-dev:i386

          wget https://www.python.org/ftp/python/$PY_VER/Python-$PY_VER.tgz
          tar -xzf Python-$PY_VER.tgz && cd Python-$PY_VER
          CC="gcc -m32" LDFLAGS="-m32" ./configure --prefix=$PREFIX --enable-shared
          make -j$(nproc) && sudo make altinstall
          cd ..

          export PATH="$PREFIX/bin:$PATH"
          export LD_LIBRARY_PATH="$PREFIX/lib"
          curl -LsSf https://astral.sh/uv/install.sh | sh
          uv venv .venv --python $PREFIX/bin/python3.13
          source .venv/bin/activate
          CC="gcc -m32" LDFLAGS="-m32" uv pip install --no-binary=:all: pyinstaller
          uv sync --extra cli
          python -m PyInstaller -F Porn_Fetch_CLI.py

          mv dist/Porn_Fetch_CLI PornFetch_Linux_CLI_x32
          echo "CLI_OUTPUT=PornFetch_Linux_CLI_x32" >> $GITHUB_ENV
          sha256sum PornFetch_Linux_CLI_x32 > checksum.txt

      - name: Test CLI
        shell: bash
        run: |
          ./${{ env.CLI_OUTPUT }} --test-mode

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CLI_linux_x32
          path: PornFetch_Linux_CLI_x32

  build-exotic-cli:
    name: CLI (linux-${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false  # Prevent one failing architecture from killing the others
      matrix:
        arch: [riscv64, s390x, ppc64le]
    steps:
      - uses: actions/checkout@v4

      - name: Build via QEMU
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: ${{ matrix.arch }}
          distro: ubuntu24.04
          run: |
            # 1. Update and install standard Python tools (No uv needed)
            apt-get update
            apt-get install -y python3-venv python3-pip python3-dev build-essential
            
            # 2. Create and activate a Virtual Environment to bypass PEP 668
            python3 -m venv /opt/venv
            export PATH="/opt/venv/bin:$PATH"
            
            # 3. Install your specific CLI dependencies directly
            # (Matches your pyproject.toml 'cli' array)
            pip install rich hue_shift pyinstaller
            
            # 4. Build the binary
            pyinstaller -F Porn_Fetch_CLI.py
            
            # 5. Rename output so the host runner can easily grab it
            mv dist/Porn_Fetch_CLI PornFetch_Linux_CLI_${{ matrix.arch }}

      - name: Checksum & Upload
        run: |
          sha256sum PornFetch_Linux_CLI_${{ matrix.arch }} > PornFetch_Linux_CLI_${{ matrix.arch }}.sha256
          
          echo "### SHA256 Checksum (${{ matrix.arch }})" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat PornFetch_Linux_CLI_${{ matrix.arch }}.sha256 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CLI_linux_${{ matrix.arch }}
          path: PornFetch_Linux_CLI_${{ matrix.arch }}

  build-android:
    name: Android (APK)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Setup Java 17 (Required by modern Android Gradle Plugin, even if target is 11)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 2. Setup Python 3.13 (Required by Chaquopy)
      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      # 3. Fix the hardcoded local path in your build.gradle.kts
      - name: Patch Chaquopy Python Path
        shell: bash
        run: |
          sed -i 's|buildPython("/home/asuna/.local/bin/python3.13")|buildPython("python")|g' Android/app/build.gradle.kts

      # 4. Setup Gradle Caching to speed up future builds
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      # 5. Build the APK
      - name: Build APK (Debug)
        working-directory: Android
        # We build 'assembleDebug' so you get an APK signed with a default key
        # that can be immediately installed on any Android phone.
        run: gradle assembleDebug

      # 6. Rename and generate checksum
      - name: Prepare Output
        run: |
          mv Android/app/build/outputs/apk/debug/app-debug.apk PornFetch_Android.apk
          sha256sum PornFetch_Android.apk > PornFetch_Android.apk.sha256

      - name: Publish Summary
        run: |
          echo "### SHA256 Checksum (Android)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat PornFetch_Android.apk.sha256 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PornFetch_Android
          path: PornFetch_Android.apk

  build-macos-universal:
    name: GUI (macos-universal)
    needs: build-gui  # Wait for the x64 and arm64 builds to finish
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Sync Dependencies
        run: uv sync --extra dev --extra av

      # 1. Download the artifacts we just built
      - name: Download macOS x64 DMG
        uses: actions/download-artifact@v4
        with:
          name: PornFetch_macos_GUI_x64
          path: dmg_x64

      - name: Download macOS arm64 DMG
        uses: actions/download-artifact@v4
        with:
          name: PornFetch_macos_GUI_arm64
          path: dmg_arm64

      # 2. Extract, Fuse, and Repackage
      - name: Create Universal Binary
        shell: bash
        run: |
          # Mount DMGs and extract the .app bundles
          hdiutil attach dmg_x64/PornFetch_macOS_GUI_x64.dmg -mountpoint /Volumes/x64_dmg
          cp -pR "/Volumes/x64_dmg/Porn Fetch.app" "PornFetch_x64.app"
          hdiutil detach /Volumes/x64_dmg
          
          hdiutil attach dmg_arm64/PornFetch_macOS_GUI_arm64.dmg -mountpoint /Volumes/arm64_dmg
          cp -pR "/Volumes/arm64_dmg/Porn Fetch.app" "PornFetch_arm64.app"
          hdiutil detach /Volumes/arm64_dmg
          
          # Use the x64 app as the base framework for our Universal app
          cp -pR "PornFetch_x64.app" "PornFetch_Universal.app"
          
          # Iterate through every file in the arm64 app
          find "PornFetch_arm64.app" -type f -print0 | while IFS= read -r -d '' arm_file; do
              rel_path="${arm_file#PornFetch_arm64.app/}"
              x64_file="PornFetch_Universal.app/$rel_path"
          
              # Ensure the file exists in the x64 app too
              if [ -f "$x64_file" ]; then
                  # Check if BOTH files are compiled Mach-O binaries
                  if file "$arm_file" | grep -q "Mach-O" && file "$x64_file" | grep -q "Mach-O"; then
                      archs=$(lipo -archs "$x64_file")
          
                      # If the base file isn't ALREADY a fat binary, fuse them
                      if ! (echo "$archs" | grep -q "arm64" && echo "$archs" | grep -q "x86_64"); then
                          echo "Fusing: $rel_path"
                          lipo -create -output "$x64_file" "$x64_file" "$arm_file"
                      fi
                  fi
              fi
          done
          
          # Re-sign the app (lipo modifies binaries, which instantly breaks existing code signatures)
          echo "Signing Universal App..."
          codesign --force --deep --sign - "PornFetch_Universal.app"
          
          # Patch the bundle to correctly integrate the Sparkle framework for updates
          echo "Patching macOS bundle for Sparkle framework..."
          uv run python src/scripts/patch_macos_bundle.py --short-version=3.8
          
          # Package back into a final Universal DMG
          mkdir dist_dmg
          cp -pR "PornFetch_Universal.app" "dist_dmg/Porn Fetch.app"
          ln -s /Applications dist_dmg/Applications
          hdiutil create -volname "PornFetch" -srcfolder dist_dmg -ov -format UDZO "PornFetch_macOS_GUI_Universal.dmg"

      # 3. Standard QA and Upload
      - name: Checksum & Summary
        run: |
          sha256sum PornFetch_macOS_GUI_Universal.dmg > PornFetch_macOS_GUI_Universal.dmg.sha256
          echo "### SHA256 Checksum (macOS Universal)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat PornFetch_macOS_GUI_Universal.dmg.sha256 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Universal Artifact
        uses: actions/upload-artifact@v4
        with:
          name: PornFetch_macOS_GUI_Universal
          path: PornFetch_macOS_GUI_Universal.dmg
