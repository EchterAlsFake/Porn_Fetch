name: Build CLI (Linux x32,x64)

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

permissions:
  contents: read

jobs:
  build-pornfetch-cli-linux-64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.13
        uses: actions/setup-python@v3
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller av
          if [ -f requirements_cli.txt ]; then pip install -r requirements_cli.txt; fi

      - name: Build Porn Fetch (CLI) (PyInstaller - Termux)
        run: |
          pyinstaller -F Porn_Fetch_CLI.py && cd dist && mv Porn_Fetch_CLI PornFetch_Linux_CLI_x64 && chmod +x PornFetch_Linux_CLI_x64

      - name: Generate SHA256 Checksum
        run: |
          sha256sum dist/PornFetch_Linux_CLI_x64 > dist/PornFetch_Linux_CLI_x64.sha256

      - name: Publish SHA256 to GitHub Actions Summary
        run: |
          echo "### SHA256 Checksum for PornFetch_Linux_CLI_x64" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat dist/PornFetch_Linux_CLI_x64.sha256 >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Archive Porn Fetch CLI (Linux_64) build
        uses: actions/upload-artifact@v4
        with:
          name: PornFetch_Linux_CLI_x64
          path: dist/PornFetch_Linux_CLI_x64

  build-pornfetch-cli-linux-32:
    runs-on: ubuntu-latest
    env:
      PY311_VERSION: "3.11.5"
      PY32_PREFIX: "/opt/python-32"
      LD_LIBRARY_PATH: "/opt/python-32/lib:/usr/lib/i386-linux-gnu"
      CC: "gcc -m32"
      CXX: "g++ -m32"
      CFLAGS: "-m32"
      LDFLAGS: "-m32"
    steps:
      - uses: actions/checkout@v4

      - name: Enable i386 & install minimal 32-bit toolchain
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gcc-multilib make pkg-config wget xz-utils ca-certificates \
            libffi-dev:i386 zlib1g-dev:i386 libbz2-dev:i386 libsqlite3-dev:i386 \
            libgdbm-dev:i386 libgdbm-compat-dev:i386 libncurses5-dev:i386 libncursesw5-dev:i386 \
            libreadline-dev:i386 libssl-dev:i386 liblzma-dev:i386 uuid-dev:i386 \
            libcrypt-dev:i386

      - name: Build Python ${{ env.PY311_VERSION }} (32-bit)
        run: |
          wget https://www.python.org/ftp/python/${PY311_VERSION}/Python-${PY311_VERSION}.tgz
          tar -xzf Python-${PY311_VERSION}.tgz
          cd Python-${PY311_VERSION}
          ./configure --prefix="${PY32_PREFIX}" --with-ensurepip=install --enable-shared
          make -j"$(nproc)"
          sudo make altinstall
          echo "${PY32_PREFIX}/bin" >> "$GITHUB_PATH"

      - name: Create 32-bit venv & install deps (no av)
        shell: bash
        run: |
          python3.11 -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip wheel setuptools
          # Build PyInstaller from source so its bootloader is compiled for i686
          pip install --no-binary=:all: pyinstaller
          pip install -r requirements_cli.txt

      - name: Build Porn Fetch (CLI) (PyInstaller - x32)
        shell: bash
        run: |
          source venv/bin/activate
          pyinstaller -F Porn_Fetch_CLI.py
          cd dist && mv Porn_Fetch_CLI PornFetch_Linux_CLI_x32 && chmod +x PornFetch_Linux_CLI_x32

          - name: Generate SHA256 Checksum
            run: sha256sum dist/PornFetch_Linux_CLI_x32 > dist/PornFetch_Linux_CLI_x32.sha256

          - name: Publish SHA256 to GitHub Actions Summary
            run: |
              {
                echo "### SHA256 Checksum for PornFetch_Linux_CLI_x32";
                echo '```';
                cat dist/PornFetch_Linux_CLI_x32.sha256;
                echo '```';
              } >> "$GITHUB_STEP_SUMMARY"

          - name: Archive Porn Fetch CLI (Linux_32) build
            uses: actions/upload-artifact@v4
            with:
              name: PornFetch_Linux_CLI_x32
              path: dist/PornFetch_Linux_CLI_x32
