name: Build GUI (macOS Universal)

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

permissions:
  contents: read

env:
  PYTHONUNBUFFERED: "1"

jobs:
  build-gui-macos:
    name: Build macOS ${{ matrix.arch_name }}
    runs-on: macos-14  # <--- ALWAYS run on ARM64 hardware (Standard Runner)
    strategy:
      fail-fast: false
      matrix:
        include:
          # Intel (x86_64) - Runs on ARM hardware via Rosetta 2
          - arch_name: x86_64
            python_arch: 'x64'  # <--- Forces Intel Python

          # Apple Silicon (ARM64) - Native
          - arch_name: arm64
            python_arch: 'arm64' # <--- Native ARM Python

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.13 (${{ matrix.arch_name }})
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          architecture: ${{ matrix.python_arch }} # <--- Installs the correct Python arch

      - name: Install uv (with cache)
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install System Dependencies
        run: |
          brew update
          brew install git cmake wget curl pkg-config coreutils

      - name: Sync dependencies (uv)
        # UV will automatically detect the Python architecture (x64 or arm64)
        # and fetch the matching wheels.
        run: |
          uv sync --extra gui --extra av

      - name: Prepare Frontend & Resources
        run: |
          chmod +x src/frontend/update.sh
          
          # 1. Run the update script in frontend
          cd src/frontend
          bash update.sh
          
          # 2. Navigate to src/scripts (sibling folder)
          cd ../scripts
          
          # 3. Run the patch script
          uv run patch.py
          
          # 4. Return to Project Root for the build step
          cd ../../

      - name: Build GUI (pyside6-deploy)
        run: |
          # Use the generic macOS spec file (it usually auto-detects)
          # OR ensure your spec file doesn't hardcode the arch
          cp src/build/pysidedeploy_macos.spec pysidedeploy.spec
          
          # Run the deploy tool
          uv run -- pyside6-deploy -c pysidedeploy.spec -f -v

      - name: Package into DMG
        run: |
          APP_NAME="Porn Fetch.app"
          DMG_NAME="PornFetch_macOS_GUI_${{ matrix.arch_name }}.dmg"
          
          # 1. Wait for filesystem to settle
          sync
          sleep 5 
          
          if [ ! -d "$APP_NAME" ]; then
            echo "::error::Build failed! $APP_NAME not found."
            exit 1
          fi
          
          # 2. Clean up any previous attempts
          rm -rf dist_dmg
          mkdir -p dist_dmg
          
          # 3. Use 'cp -pR' to preserve permissions and stay recursive
          cp -pR "$APP_NAME" dist_dmg/
          ln -s /Applications dist_dmg/Applications
          
          # 4. Run hdiutil with a retry logic (just in case)
          for i in {1..3}; do
            hdiutil create \
              -volname "PornFetch" \
              -srcfolder dist_dmg \
              -ov -format UDZO \
              -imagekey zlib-level=9 \
              "$DMG_NAME" && break || sleep 10
          done

      - name: Generate SHA256 Checksum
        run: |
          sha256sum "$DMG_OUTPUT" > "${DMG_OUTPUT}.sha256"

      - name: Publish SHA256 to Summary
        run: |
          echo "### SHA256 (${{ matrix.arch_name }})" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat "${DMG_OUTPUT}.sha256" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Archive DMG build
        uses: actions/upload-artifact@v4
        with:
          name: PornFetch_macOS_GUI_${{ matrix.arch_name }}
          path: ${{ env.DMG_OUTPUT }}